<%- include('partials/head', { pageTitle: 'NETS QR | Supermarket', bodyClass: 'bg-surface' }) %>
<%- include('partials/topbar') %>

<main class="page-section">
  <div class="container">
    <div class="card border-0 shadow-sm">
      <div class="card-body">
        <h4 class="mb-2"><%= title %></h4>
        <p class="text-muted mb-3" id="nets-status">Scan the QR code with your NETS app to complete payment.</p>

        <div class="text-center">
          <img src="<%= qrCodeUrl %>" alt="NETS QR" class="img-fluid rounded" style="max-width: 320px;">
          <div class="mt-3">
            <span class="fw-semibold">Total:</span> $<%= total %>
          </div>
          <div class="small text-muted mt-1">Transaction ref: <%= txnRetrievalRef %></div>
          <div class="small text-muted">Timer: <span id="nets-timer"><%= timer %></span>s</div>
        </div>

        <div class="alert alert-info mt-4">
          Keep this page open until payment completes. You can check your order history after payment.
        </div>
        <div class="d-flex gap-2">
          <a class="btn btn-success fw-semibold" href="/orders/history">Go to order history</a>
          <a class="btn btn-secondary fw-semibold" href="/shopping">Back to shopping</a>
        </div>
      </div>
    </div>
  </div>
</main>

<%- include('partials/footer') %>

<script src="https://unpkg.com/event-source-polyfill"></script>
<script>
  (function() {
    const timerEl = document.getElementById('nets-timer');
    const statusEl = document.getElementById('nets-status');
    if (!timerEl) return;
    let remaining = parseInt(timerEl.textContent, 10);
    if (!Number.isFinite(remaining)) return;

    const txnRetrievalRef = "<%= txnRetrievalRef %>";
    const EventSourceImpl = window.EventSource || window.EventSourcePolyfill;
    let sse = null;

    if (EventSourceImpl) {
      const url = `/sse/payment-status/${txnRetrievalRef}`;
      sse = window.EventSource
        ? new EventSource(url)
        : new EventSourcePolyfill(url, { heartbeatTimeout: 150000 });

      sse.addEventListener('message', (event) => {
        let data;
        try {
          data = JSON.parse(event.data);
        } catch (e) {
          return;
        }

        if (data && data.success) {
          if (statusEl) {
            statusEl.textContent = 'Payment confirmed. Finalising order...';
          }
          if (sse) sse.close();
          window.location.href = `/nets-qr/confirm?txnRetrievalRef=${encodeURIComponent(txnRetrievalRef)}`;
        } else if (data && data.fail) {
          if (sse) sse.close();
          window.location.href = '/nets-qr/fail';
        }
      });

      sse.addEventListener('error', () => {
        if (statusEl) {
          statusEl.textContent = 'Waiting for NETS confirmation...';
        }
      });
    }

    const interval = setInterval(() => {
      remaining -= 1;
      if (remaining <= 0) {
        timerEl.textContent = '0';
        clearInterval(interval);
        if (sse) sse.close();
        window.location.href = '/nets-qr/fail?reason=timeout';
        return;
      }
      timerEl.textContent = String(remaining);
    }, 1000);
  })();
</script>
