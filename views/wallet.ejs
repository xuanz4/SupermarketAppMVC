<%- include('partials/head', { pageTitle: 'Wallet | Supermarket App', bodyClass: 'bg-surface' }) %>
<%- include('partials/topbar') %>

<main class="page-section">
  <div class="container">
    <% if (messages && messages.length) { %>
      <% messages.forEach(function(message) { %>
        <div class="alert alert-success"><%= message %></div>
      <% }); %>
    <% } %>

    <% if (errors && errors.length) { %>
      <% errors.forEach(function(error) { %>
        <div class="alert alert-danger"><%= error %></div>
      <% }); %>
    <% } %>

    <div class="row g-4">
      <div class="col-12 col-lg-6">
          <div class="card border-0 shadow-sm">
            <div class="card-body">
              <h4 class="mb-2">Your e-wallet</h4>
              <p class="text-muted mb-3">Current balance: <strong>$<%= Number(walletBalance || 0).toFixed(2) %></strong></p>

              <% if (netsQr && netsQr.qrCodeUrl) { %>
                <div class="card border-0 shadow-sm mb-3">
                  <div class="card-body">
                    <h5 class="mb-2"><%= netsQr.title %></h5>
                    <p class="text-muted mb-3">Scan the NETS QR code to top up your wallet.</p>
                    <div class="text-center">
                      <img src="<%= netsQr.qrCodeUrl %>" alt="NETS QR" class="img-fluid rounded" style="max-width: 320px;">
                      <div class="mt-3">
                        <span class="fw-semibold">Amount:</span> $<%= netsQr.total %>
                      </div>
                      <div class="small text-muted mt-1">Transaction ref: <%= netsQr.txnRetrievalRef %></div>
                      <div class="small text-muted">Timer: <span id="nets-timer"><%= netsQr.timer %></span>s</div>
                    </div>
                    <div class="alert alert-info mt-4" id="nets-topup-status">
                      NETS top ups are credited automatically once payment is confirmed.
                    </div>
                  </div>
                </div>
              <% } %>

              <div class="card border-0 shadow-sm">
                <div class="card-body">
                  <h5 class="mb-3">Top up with PayPal</h5>
                <div class="mb-3">
                  <label class="form-label">Amount (SGD)</label>
                  <input type="number" step="0.01" min="1" class="form-control" id="paypal-topup-amount" placeholder="e.g. 20.00">
                </div>
                <div id="paypal-topup-button"></div>
              </div>
            </div>

            <div class="card border-0 shadow-sm mt-3">
              <div class="card-body">
                <h5 class="mb-3">Top up with NETS QR</h5>
                <form action="/wallet/topup/nets/create" method="POST" class="row gy-3">
                  <div class="col-12">
                    <label class="form-label">Amount (SGD)</label>
                    <input type="number" step="0.01" min="1" name="amount" class="form-control" placeholder="e.g. 20.00" required>
                  </div>
                  <div class="col-12 d-flex justify-content-end">
                    <button type="submit" class="btn btn-success fw-semibold">Generate NETS QR</button>
                  </div>
                </form>
                <p class="small text-muted mt-2 mb-0">NETS top ups are credited automatically after confirmation.</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-lg-6">
        <div class="card border-0 shadow-sm">
          <div class="card-body">
            <h5 class="mb-3">Recent top ups</h5>
            <% if (topups && topups.length) { %>
              <div class="table-responsive">
                <table class="table table-modern align-middle mb-0">
                  <thead>
                    <tr>
                      <th>Provider</th>
                      <th>Status</th>
                      <th class="text-end">Amount</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% topups.forEach(function(topup) { %>
                      <tr>
                        <td class="text-uppercase fw-semibold"><%= topup.provider %></td>
                        <td><span class="badge bg-light text-dark"><%= topup.status %></span></td>
                        <td class="text-end">$<%= Number(topup.amount || 0).toFixed(2) %></td>
                      </tr>
                    <% }); %>
                  </tbody>
                </table>
              </div>
            <% } else { %>
              <p class="text-muted mb-0">No top ups yet.</p>
            <% } %>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<%- include('partials/footer') %>

<% if (paypalClientId) { %>
  <script src="https://www.paypal.com/sdk/js?client-id=<%= paypalClientId %>&currency=SGD"></script>
<% } %>

<script>
  (function() {
    if (!window.paypal) return;

    const amountInput = document.getElementById('paypal-topup-amount');
    const buttonContainer = document.getElementById('paypal-topup-button');
    if (!amountInput || !buttonContainer) return;

    paypal.Buttons({
      createOrder: function() {
        const amount = Number(amountInput.value || 0).toFixed(2);
        if (!amount || Number(amount) <= 0) {
          alert('Please enter a valid top up amount.');
          return;
        }

        return fetch('/wallet/topup/paypal/create-order', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ amount })
        })
          .then((response) => response.json())
          .then((order) => order.id);
      },
      onApprove: function(data) {
        return fetch('/wallet/topup/paypal/capture', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ orderId: data.orderID })
        })
          .then((response) => response.json())
          .then((result) => {
            if (result && result.redirect) {
              window.location.href = result.redirect;
              return;
            }
            alert(result && result.error ? result.error : 'Top up completed, but wallet was not updated.');
          });
      },
      onError: function(err) {
        console.error('PayPal top up error:', err);
        alert('PayPal top up failed. Please try again.');
      }
    }).render('#paypal-topup-button');
  })();
</script>

<% if (netsQr && netsQr.timer) { %>
  <script src="https://unpkg.com/event-source-polyfill"></script>
  <script>
    (function() {
      const timerEl = document.getElementById('nets-timer');
      const statusEl = document.getElementById('nets-topup-status');
      if (!timerEl) return;
      let remaining = parseInt(timerEl.textContent, 10);
      if (!Number.isFinite(remaining)) return;
      const txnRetrievalRef = "<%= netsQr.txnRetrievalRef %>";
      const EventSourceImpl = window.EventSource || window.EventSourcePolyfill;
      let sse = null;

      if (EventSourceImpl) {
        const url = `/sse/payment-status/${txnRetrievalRef}`;
        sse = window.EventSource
          ? new EventSource(url)
          : new EventSourcePolyfill(url, { heartbeatTimeout: 150000 });

        sse.addEventListener('message', (event) => {
          let data;
          try {
            data = JSON.parse(event.data);
          } catch (e) {
            return;
          }

          if (data && data.success) {
            if (statusEl) {
              statusEl.textContent = 'Payment confirmed. Crediting your wallet...';
            }
            if (sse) sse.close();
            window.location.href = `/wallet/topup/nets/confirm?txnRetrievalRef=${encodeURIComponent(txnRetrievalRef)}`;
          } else if (data && data.fail) {
            if (sse) sse.close();
            window.location.href = '/wallet?nets=fail';
          }
        });

        sse.addEventListener('error', () => {
          if (statusEl) {
            statusEl.textContent = 'Waiting for NETS confirmation...';
          }
        });
      }

      const interval = setInterval(() => {
        remaining -= 1;
        if (remaining <= 0) {
          timerEl.textContent = '0';
          clearInterval(interval);
          if (sse) sse.close();
          window.location.href = '/wallet?nets=fail';
          return;
        }
        timerEl.textContent = String(remaining);
      }, 1000);
    })();
  </script>
<% } %>
