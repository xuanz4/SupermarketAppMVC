<% const pageTitle = 'Deliveries | Supermarket App'; %>
<%- include('partials/head') %>
<%- include('partials/topbar') %>

<section class="page-section">
  <div class="container">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3 mb-4">
      <div>
        <p class="mb-1 text-muted">Administrator dashboard</p>
        <h2 class="mb-0">Delivery overview</h2>
      </div>
      <span class="badge bg-light text-dark px-3 py-2">Total orders: <strong><%= orders ? orders.length : 0 %></strong></span>
    </div>

    <% if (messages && messages.length) { %>
      <% messages.forEach(function(message) { %>
        <div class="alert alert-success"><%= message %></div>
      <% }); %>
    <% } %>

    <% if (errors && errors.length) { %>
      <% errors.forEach(function(error) { %>
        <div class="alert alert-danger"><%= error %></div>
      <% }); %>
    <% } %>

    <% const statusGroups = ['processing', 'dispatched', 'delivered'];
       const grouped = { processing: [], dispatched: [], delivered: [] };
       (orders || []).forEach(function(o) {
         const key = statusGroups.includes(o.status) ? o.status : 'processing';
         grouped[key].push(o);
       });
    %>

    <% statusGroups.forEach(function(status) { %>
      <% const list = grouped[status] || []; %>
      <div class="card shadow-sm mb-4">
        <div class="card-body d-flex justify-content-between align-items-center flex-wrap gap-2">
          <div>
            <p class="mb-1 text-muted text-uppercase small">Status</p>
            <h4 class="mb-0 text-capitalize"><%= status %></h4>
          </div>
          <span class="badge bg-light text-dark px-3 py-2">Count: <strong><%= list.length %></strong></span>
        </div>
        <div class="card-body pt-0">
          <% if (!list.length) { %>
            <div class="empty-state">
              <h5>No <%= status %> orders</h5>
              <p class="text-muted mb-0">Orders set to this status will appear here.</p>
            </div>
          <% } else { %>
            <div class="accordion" id="admin-deliveries-<%= status %>">
              <% list.forEach(function(order, index) { %>
                <div class="accordion-item">
                  <h2 class="accordion-header" id="delivery-heading-<%= status %>-<%= order.id %>">
                    <button class="accordion-button <%= index === 0 ? '' : 'collapsed' %>" type="button" data-bs-toggle="collapse" data-bs-target="#delivery-<%= status %>-<%= order.id %>" aria-expanded="<%= index === 0 ? 'true' : 'false' %>" aria-controls="delivery-<%= status %>-<%= order.id %>">
                      <div class="w-100 d-flex flex-column flex-md-row align-items-md-center justify-content-between">
                        <div>
                          <span class="me-2 fw-semibold">Order #<%= order.id %></span>
                          <span class="text-muted small"><%= new Date(order.created_at).toLocaleString() %></span>
                        </div>
                        <div class="d-flex flex-column flex-md-row align-items-md-center gap-2 mt-2 mt-md-0">
                          <span class="badge <%= order.delivery_method === 'delivery' ? 'bg-primary-subtle text-primary' : 'bg-light text-dark' %> text-uppercase">
                            <%= order.delivery_method === 'delivery' ? 'Delivery' : 'Pickup' %>
                          </span>
                          <span class="badge bg-secondary-subtle text-dark text-uppercase"><%= (order.status || 'processing').replace('_', ' ') %></span>
                          <span class="badge bg-dark-subtle text-dark">Total: $<%= Number(order.total).toFixed(2) %></span>
                        </div>
                      </div>
                    </button>
                  </h2>
                  <div id="delivery-<%= status %>-<%= order.id %>" class="accordion-collapse collapse <%= index === 0 ? 'show' : '' %>" aria-labelledby="delivery-heading-<%= status %>-<%= order.id %>" data-bs-parent="#admin-deliveries-<%= status %>">
                    <div class="accordion-body">
                      <div class="row g-4">
                        <div class="col-12 col-lg-4">
                          <div class="card h-100 shadow-sm">
                            <div class="card-body">
                              <h5 class="card-title mb-1"><%= order.username %></h5>
                              <p class="text-muted small mb-3"><%= order.email %> | <%= order.contact %></p>
                              <p class="mb-2"><strong>Saved address:</strong><br><span class="text-muted"><%= order.account_address %></span></p>
                              <p class="mb-0">
                                <span class="badge <%= order.free_delivery ? 'bg-success-subtle text-success' : 'bg-light text-muted' %>">
                                  <%= order.free_delivery ? 'Free delivery user' : 'Standard delivery' %>
                                </span>
                              </p>
                            </div>
                          </div>
                        </div>
                        <div class="col-12 col-lg-8">
                          <div class="card shadow-sm mb-3">
                            <div class="card-body">
                              <h5 class="card-title">Items</h5>
                              <% const items = orderItems[order.id] || []; %>
                              <% if (items.length) { %>
                                <div class="table-responsive">
                                  <table class="table align-middle mb-0">
                                    <thead>
                                      <tr>
                                        <th scope="col">Product</th>
                                        <th scope="col" class="text-center">Qty</th>
                                        <th scope="col" class="text-end">Total</th>
                                      </tr>
                                    </thead>
                                    <tbody>
                                      <% items.forEach(function(item) { %>
                                        <tr>
                                          <td><%= item.productName %></td>
                                          <td class="text-center"><%= item.quantity %></td>
                                          <td class="text-end">$<%= (Number(item.price) * Number(item.quantity)).toFixed(2) %></td>
                                        </tr>
                                      <% }); %>
                                    </tbody>
                                  </table>
                                </div>
                              <% } else { %>
                                <p class="text-muted mb-0">No line items recorded.</p>
                              <% } %>
                            </div>
                          </div>

                          <div class="card shadow-sm">
                            <div class="card-body">
                              <h5 class="card-title mb-3">Delivery management</h5>
                              <form action="/orders/<%= order.id %>/delivery" method="POST" class="row gy-3">
                                <div class="col-12 col-md-4">
                                  <label class="form-label">Method</label>
                                  <select name="deliveryMethod" class="form-select">
                                    <option value="pickup" <%= order.delivery_method === 'pickup' ? 'selected' : '' %>>Pickup</option>
                                    <option value="delivery" <%= order.delivery_method === 'delivery' ? 'selected' : '' %>>Delivery</option>
                                  </select>
                                </div>
                                <div class="col-12 col-md-4">
                                  <label class="form-label">Status</label>
                                  <select name="status" class="form-select">
                                    <option value="processing" <%= order.status === 'processing' ? 'selected' : '' %>>Processing</option>
                                    <option value="dispatched" <%= order.status === 'dispatched' ? 'selected' : '' %>>Dispatched</option>
                                    <option value="delivered" <%= order.status === 'delivered' ? 'selected' : '' %>>Delivered</option>
                                  </select>
                                </div>
                                <div class="col-12 col-md-4">
                                  <label for="admin-delivery-address-<%= order.id %>" class="form-label">Delivery address</label>
                                  <textarea
                                    class="form-control"
                                    id="admin-delivery-address-<%= order.id %>"
                                    name="deliveryAddress"
                                    rows="2"
                                    placeholder="Enter delivery details"><%= order.delivery_address || order.account_address || '' %></textarea>
                                  <small class="text-muted">Only required when delivery is selected.</small>
                                </div>
                                <div class="col-12">
                                  <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="waive-fee-<%= order.id %>" name="waiveFee" <%= Number(order.delivery_fee || 0) === 0 ? 'checked' : '' %>>
                                    <label class="form-check-label" for="waive-fee-<%= order.id %>">Waive the 1.50 delivery fee for this order</label>
                                  </div>
                                  <small class="text-muted">
                                    Current fee: <%= Number(order.delivery_fee || 0) > 0 ? '$' + Number(order.delivery_fee).toFixed(2) : 'Free' %>
                                  </small>
                                </div>
                                <div class="col-12 d-flex justify-content-end gap-2">
                                  <button type="submit" class="btn btn-primary btn-lg fw-semibold">Save changes</button>
                                </div>
                              </form>
                              <div class="border-top pt-3 mt-3">
                                <h6 class="mb-2">Payment</h6>
                                <% if (order.payment) { %>
                                  <p class="mb-2 text-muted">
                                    <span class="fw-semibold text-dark"><%= (order.payment.provider || 'unknown').toUpperCase() %></span>
                                    <span class="ms-2 badge <%= order.payment.status === 'refunded' ? 'bg-warning-subtle text-warning' : 'bg-success-subtle text-success' %>">
                                      <%= order.payment.status %>
                                    </span>
                                    <span class="ms-2">$<%= Number(order.payment.amount || 0).toFixed(2) %> <%= order.payment.currency || 'SGD' %></span>
                                  </p>
                                  <% if (order.payment.status === 'paid') { %>
                                    <span class="text-muted">Ready for refund.</span>
                                  <% } %>
                                <% } else { %>
                                  <p class="text-muted mb-0">No payment record for this order.</p>
                                <% } %>
                              </div>
                              <div class="border-top pt-3 mt-3">
                                <h6 class="mb-2">Refund request</h6>
                                <% if (order.refundRequest) { %>
                                  <p class="mb-2 text-muted">
                                    <span class="fw-semibold text-dark text-uppercase"><%= order.refundRequest.status || 'pending' %></span>
                                    <span class="ms-2"><%= new Date(order.refundRequest.created_at).toLocaleString() %></span>
                                  </p>
                                  <p class="mb-2"><%= order.refundRequest.reason %></p>
                                  <% if (order.refundRequest.image_path) { %>
                                    <a class="btn btn-secondary btn-sm fw-semibold" href="<%= order.refundRequest.image_path %>" target="_blank" rel="noopener">View photo</a>
                                  <% } %>
                                <% } else { %>
                                  <p class="text-muted mb-0">No refund request for this order.</p>
                                <% } %>
                              </div>
                              <div class="d-flex justify-content-end gap-2 mt-3">
                                <% if (order.payment && order.payment.status === 'paid') { %>
                                  <form action="/payments/<%= order.id %>/refund" method="POST">
                                    <button type="submit" class="btn btn-warning btn-lg fw-semibold" onclick="return confirm('Refund order #<%= order.id %>? This will issue a full refund.');">
                                      Issue refund
                                    </button>
                                  </form>
                                <% } %>
                                <form action="/orders/<%= order.id %>/delete" method="POST">
                                  <button type="submit" class="btn btn-danger btn-lg fw-semibold" onclick="return confirm('Delete order #<%= order.id %>? This cannot be undone.');">
                                    Delete order
                                  </button>
                                </form>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
              <% }); %>
            </div>
          <% } %>
        </div>
      </div>
    <% }); %>
  </div>
</section>

<%- include('partials/footer') %>
